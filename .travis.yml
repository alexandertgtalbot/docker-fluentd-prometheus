sudo: required
services:
- docker
env:
  global:
  - BUILD_FLUENTD_VERSION=v1.9.0-1.0
  - BUILD_FLUENTD_PLUGIN_PROMETHEUS_VERSION=1.7.0
  - BUILD_VERSION=${BUILD_FLUENTD_VERSION}_${BUILD_FLUENTD_PLUGIN_PROMETHEUS_VERSION}
  - BUILD_DOCKER_TAG=${BUILD_VERSION}_${TRAVIS_BUILD_NUMBER}
  - DOCKER_USERNAME=alexandertgtalbot
  - DOCKER_NAME_SPACE=${DOCKER_USERNAME}
  - DOCKER_IMAGE_NAME=fluent-prometheus

  - secure: K9t80axZUK7kZSgqrmwGo80GG5CiWSta19cDeGALBGhcnTgXHbYzKim6yd4dvnog9u6MHwNlITd8Wye+UThR72/kXpOpkgEYVOd5kLeZl7SgmR3FT6p8SjA88B/BvOV3MADcqNMaKlIiHj3D8K7+ZJTw05EMUCnK6KkPf32UFdAoNwl9Zap9us0sgXD44iUalU/tnflgUVgHqui/YlXadoCiZZQPr5in3G2sLCY1OkSHa2/dKHoOqPqQtUQgxqJ1Qu6g2EqJWQAP5MuGdAhQBPaf0dulLfQB1bvN7CnI1H+oJgwuU7WNkCCnkp6EjNVedUofoMw/AZnGToTMc7LykIIvtOExgf6eNRfFqAFlW+QMDqxJdiyJiEtIne7Iyt1QNJ6KU0IKc6vC5Dg9SsBB1bggmAbhDC0N1r7XI5d1noaiYwsnVW7uCFGwDZuUSvMfMmqyWXtzVRZ/LhyCGt6nvuvL2n0L4VvYInpOnpQQ+xterPuaGuUSO0INT2sdIRQLoWL7ixjt+i681rJerudRQ4CcmSlii1kFkNbgUv994kodhbQ5LDJcljiarNHb9AS99ObqoKD77B0DEppcmwOIf4T+lu4Wg9G/emS78vhsNZsnxreLAT7rWblUnlV2eCfWdptR2/ush89WpXqnFN5Vm/PpB0BM0xPhv1oPuVTi4nU=

jobs:
  include:
  - stage: Lint Dockerfile.
    script:
    - make linter

  - stage: Build Dev Docker Image and Publish to DockerHub.
    if: branch != master
    script:
    - make
    - docker login -u="${DOCKER_USERNAME}" -p="${DOCKER_PASSWORD}"
    - docker tag  ${DOCKER_NAME_SPACE}/${DOCKER_IMAGE_NAME}:${BUILD_DOCKER_TAG} ${DOCKER_NAME_SPACE}/${DOCKER_IMAGE_NAME}:${BUILD_DOCKER_TAG}_dev
    - docker tag  ${DOCKER_NAME_SPACE}/${DOCKER_IMAGE_NAME}:${BUILD_DOCKER_TAG} ${DOCKER_NAME_SPACE}/${DOCKER_IMAGE_NAME}:dev
    - docker push ${DOCKER_NAME_SPACE}/${DOCKER_IMAGE_NAME}:${BUILD_DOCKER_TAG}_dev
    - docker push ${DOCKER_NAME_SPACE}/${DOCKER_IMAGE_NAME}:dev
    - docker logout

  - stage: Build Stable/Latest Docker Image and Publish to DockerHub.
    if: branch = master
    script:
    - make
    - docker login -u="${DOCKER_USERNAME}" -p="${DOCKER_PASSWORD}"
    - docker push ${DOCKER_NAME_SPACE}/${DOCKER_IMAGE_NAME}:latest
    - docker tag  ${DOCKER_NAME_SPACE}/${DOCKER_IMAGE_NAME}:latest ${DOCKER_NAME_SPACE}/${DOCKER_IMAGE_NAME}:${BUILD_DOCKER_TAG}
    - docker push ${DOCKER_NAME_SPACE}/${DOCKER_IMAGE_NAME}:${BUILD_DOCKER_TAG}
    - docker logout
